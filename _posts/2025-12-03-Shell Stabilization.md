---
title: 쉘 안정화 (Shell Stabilization)
author: P0LESTAR
date: 2025-12-03 00:01:01 +0800
categories: [Webhacking]
tags: [쉘 안정화, Shell Stabilization, tty, pty]
#pin: true
sitemap:
  changefreq: monthly
  priority: 0.5
---

# 리버스 쉘 안정화하기

## 쉘 안정화가 필요한 이유

리버스 쉘(Reverse Shell)을 성공적으로 획득했을 때, 초기 쉘은 일반적으로 **불안정한 상태(Non-Interactive Shell)**입니다. 이 불안정한 쉘에는 다음과 같은 명백한 한계가 있습니다.

* **방향키 (화살표 키) 작동 불가**: 방향키를 누르면 이상한 문자열이 출력됩니다.
* **Tab 자동 완성 불가**: 명령어나 파일 이름을 쉽게 완성할 수 없습니다.
* **Ctrl+C의 위험**: 프로세스를 중단해야 할 때 `Ctrl+C`를 누르면 현재 쉘 세션 자체가 완전히 종료될 수 있습니다.
* **화면 출력 오류**: 화면이 깨지거나 입력한 내용이 중복되어 출력될 수 있습니다.

이러한 문제를 해결하고 일반적인 리눅스 터미널처럼 자유롭게 사용할 수 있도록 **대화형(Interactive) 쉘**로 만드는 과정이 바로 쉘 안정화입니다.

<br>

---

## 쉘 안정화 4단계 (Python pty 모듈 활용)

쉘 안정화는 **피해 시스템(Target Machine)**과 **공격 시스템(Host/Attacker Machine)** 양쪽에서 명령어를 실행해야 합니다.

### 1단계: TTY 스폰 (피해 시스템)

가장 먼저, 피해 시스템에서 **Python의 `pty` 모듈**을 사용하여 가상 터미널(Pseudo-Terminal, TTY) 환경을 만들고 새로운 `bash` 쉘을 실행합니다.

이 명령어는 기존의 불안정한 쉘 연결 위에 새로운 쉘 환경을 띄웁니다.

| 실행 위치 | 명령어 |
| :--- | :--- |
| **피해 시스템** | `python3 -c 'import pty;pty.spawn("/bin/bash")'` |

>피해 시스템에 Python2만 설치되어 있다면 `python -c 'import pty; pty.spawn("/bin/bash")'`를 사용합니다.
{: .prompt-info }

### 2단계: 프로세스 일시 중지 (공격 시스템)

쉘이 스폰된 후, 아직 안정화되지 않았기 때문에 이상하게 동작할 수 있습니다. 이제 공격 시스템(여러분이 리버스 쉘을 수신한 터미널)에서 현재 실행 중인 쉘 프로세스를 잠시 일시 중지(Suspend)하고 백그라운드(Background)로 보냅니다.

| 실행 위치 | 동작 |
| :--- | :--- |
| **공격 시스템** | **Ctrl + Z** (`^Z`)를 누릅니다. |

이 동작을 수행하면 쉘 세션이 일시 정지되며, 공격 시스템의 터미널 프롬프트(예: `[1]+  Stopped  nc -lvnp 4444`)가 다시 나타납니다.

### 3단계: 터미널 설정 조정 및 포그라운드 복귀 (공격 시스템)

일시 중지된 쉘을 다시 포그라운드로 불러오기 전에, **`stty` 명령어**를 사용해 공격 시스템 터미널의 입력 처리 모드를 조정합니다.

| 실행 위치 | 명령어 |
| :--- | :--- |
| **공격 시스템** | `stty raw -echo; fg` |

이 명령어를 실행하면 쉘이 다시 포그라운드로 돌아오며 (이때 화면에 아무것도 출력되지 않을 수 있음) **완벽한 대화형 쉘**에 가까워집니다.

### 4단계: TERM 환경 변수 설정 (피해 시스템)

마지막으로, 쉘이 화살표 키나 탭 자동 완성 같은 고급 기능을 정확히 인식할 수 있도록 피해 시스템에서 **TERM 환경 변수**를 설정합니다.

| 실행 위치 | 명령어 |
| :--- | :--- |
| **피해 시스템** | `export TERM=xterm` |

>더 다양한 색상과 기능을 원한다면 `export TERM=xterm-256color`를 사용하면 됩니다.
{: .prompt-tip }

<br>

---

## 핵심 명령어 설명

### 1. `pty.spawn("/bin/bash")`

* **`pty` 모듈**: Python의 `pty` (pseudo-terminal utility) 모듈은 프로그램과 사용자 간의 상호작용을 관리하는 가상 터미널을 생성하고 제어합니다.
* **역할**: 이 함수는 `/bin/bash`와 같은 프로그램을 실행하고, 실행된 프로그램의 표준 입출력(Standard I/O)을 현재 터미널과 연결하여 **대화형 세션의 기반**을 만듭니다.

### 2. `stty raw -echo`

* **`stty` (Set Terminal TYpes)**: 현재 터미널 라인의 설정을 변경하는 명령어입니다.
* **`raw` 모드**: 입력 처리 모드를 **Raw Mode (원시 모드)**로 변경합니다.
    * `icanon` (정규 입력 처리) 기능을 비활성화하여, 사용자가 `Enter`를 누를 때까지 기다리지 않고 키보드 입력 문자를 **즉시** 쉘에게 전달합니다. 이를 통해 화살표 키나 `Ctrl+C` 같은 제어 문자도 정상적으로 작동하게 됩니다.
* **`-echo`**: **반향(Echo) 기능**을 비활성화합니다.
    * 일반적으로 문자를 입력하면 화면에 즉시 출력되는데, 불안정한 쉘에서 이 기능이 중복 출력 문제를 일으킬 수 있습니다. `-echo`는 이를 막아 화면을 깔끔하게 유지합니다.

### 3. `fg`

* **`fg` (Foreground)**: 이전에 `Ctrl+Z`를 눌러 **백그라운드**로 보냈던 (일시 정지된) 가장 최근의 작업을 **포그라운드**로 다시 불러와 실행을 재개합니다.

---

```bash
which python 
python -c ‘import pty;pty.spawn(“/bin/bash”)’
^Z
stty raw -echo; fg
export TERM=xterm
```


#### 참고
<https://saeed0x1.medium.com/stabilizing-a-reverse-shell-for-interactive-access-a-step-by-step-guide-c5c32f0cb839>
<https://velog.io/@agnusdei1207/Shell-%EC%95%88%EC%A0%95%ED%99%94>